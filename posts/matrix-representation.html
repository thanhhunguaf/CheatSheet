<html>

<!-- Mirrored from thefullsnack.com/posts/matrix-representation.html by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 12 May 2020 03:19:57 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf8" /><!-- /Added by HTTrack -->
<head>
<title>Chuyện biểu diễn ma trận trên máy tính | Huy's Blog</title>
<meta charset="utf-8">
<meta http-equiv="content-type" content="text/html;"><meta name=viewport content="initial-scale=1.0 maximum-scale=1.0">
<meta property='og:image' content='img/emulator-display-matrix.png'>
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="manifest" href="../manifest.json">
<link rel="mask-icon" href="../safari-pinned-tab.svg" color="#5bbad5">
<meta name="theme-color" content="#ffffff">
<link href="../css/theme.dist.css" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="../emoji/css/emoji.dist.css">
<link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700|Space+Mono:400,700&amp;display=swap&amp;subset=vietnamese" rel="stylesheet">

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-92158965-1"></script>
<script>
	       window.dataLayer = window.dataLayer || [];
	       function gtag(){dataLayer.push(arguments);}
	       gtag('js', new Date());

	       gtag('config', 'UA-92158965-1');
	      </script>
</head>
<body lang="en" class="post">
<div class="header lightweight-theme">
<a href="../index.html"><span class="avatar"></span></a>
</div>
<div class="container">
<div class="main">
<h1><span>Chuyện biểu diễn ma trận trên máy tính</span></h1>
<p>Cách đây mấy hôm mình có share cái screenshot trên Facebook, khoe linh tinh vụ mình đang viết lại cái <a href="tu-viet-emulator.html">CHIP-8 emulator</a> bằng Rust.</p>
<p><img src="img/chip8-emulator-rust.png" alt="" /></p>
<p>Mãi cho đến hôm nay thì vẫn viết chưa xong, chán quá nên ngồi viết mấy dòng linh tinh về quá trình này.</p>
<p>Phàm làm bất cứ chuyện gì, đều là cả một quá trình <i class='em em-joy'></i> viết Emulator hay code bất cứ thứ gì cũng vậy. Và trong quá trình đó thì người viết luôn phải trải qua vô số những quyết định về mặt kĩ thuật, ví dụ như nên dùng <code>if..else</code> hay <code>pattern matching</code>, viết test hay ko test <i class='em em-smirk'></i>, chia module hay viết 100 ngàn dòng trong 1 file,...</p>
<hr />
<p>Một trong những quyết định đau đầu nhất của mình đó là chọn cấu trúc dữ liệu để biểu diễn ma trận hiển thị (display matrix) - tức là cái màn hình cho emulator.</p>
<p><img src="img/emulator-display-matrix.png" alt="" /></p>
<p>Như đã đề cập ở bài <a href="tu-viet-emulator.html">Tự viết Emulator</a>, màn hình của CHIP-8 là một ma trận $64 \times 32$. Nên cách biểu diễn thường gặp nhất đó là một mảng số nguyên (integer) hai chiều.</p>
<p>Tuy nhiên, việc dùng số nguyên rất là tốn kém, trong Rust, kiểu số nguyên nhỏ nhất là <code>i8</code>, chiếm <strong>1 byte</strong> (8 bits), và trong JavaScript thì còn tệ hơn nữa khi một giá trị kiểu <code>Number</code> mặc định chiếm bà nó <strong>8 bytes</strong> (64 bits). Nhân lên, để khai báo một mảng hai chiều cho ma trận hiển thị của CHIP-8 ta cần $64 \times 32 \times 8 = 16,384$ bits trong bộ nhớ nếu dùng Rust (tương đương với <strong>2 KB</strong>), và <strong>131,072 bits</strong> tương đương với hơn <strong>16 KB</strong> nếu xài JavaScript.</p>
<p>Con số có vẻ không lớn nếu chạy trên máy tính, nhưng nếu bạn đang implement cho các nền tảng èo ọp hơn <i class='em em-joy'></i> như là Arduino thì đây là cả một vấn đề cực kì lớn. Đơn cử, dòng Arduino phổ biến nhất là UNO R3, sử dụng vi xử lý <a href="https://store.arduino.cc/arduino-uno-rev3">ATmega328P</a> và bộ nhớ <a href="https://www.arduino.cc/en/Tutorial/Memory">SRAM (static random access memory)</a> của nó chỉ có đúng <strong>2 KB</strong>.</p>
<p>Quèo, trên thực tế thì bạn vẫn không thể chạy trực tiếp CHIP-8 emulator trên Arduino được vì tính riêng dung lượng bộ chớ chính của nó cũng đã ngốn mất <strong>4096 bytes</strong> rồi <i class='em em-weary'></i> trong trường hợp này chúng ta cần dùng thêm một con chip khác để làm external RAM, tuy nhiên, vấn đề này nằm ngoài phạm vi bài viết, có thể mình sẽ nói tới trong một bài khác.</p>
<hr />
<p>Dễ nhận thấy, đối với CHIP-8, màn hình hiển thị chỉ gồm 2 màu trắng đen, mỗi pixel chỉ có 2 trạng thái đó là <strong>on</strong> hoặc <strong>off</strong>, tương đương với chỉ có 2 giá trị <strong>0</strong> hoặc <strong>1</strong>, vậy thì việc dùng số nguyên để biểu diễn là không cần thiết.</p>
<p>Kiểu dữ liệu nào chỉ có 2 trạng thái nhỉ? <code>bool</code>! Tuy nhiên ngay cả kiểu <code>bool</code> trong Rust cũng chiếm tới <strong>1 byte</strong> (8 bits). Còn trong JavaScript thì mình chịu, không có tài liệu nào nói cụ thể, các đoạn code tính size của 1 type thì ghi nó tận <strong>4 bytes</strong> <i class='em em-joy'></i>. Mình không tin <i class='em em-angry'></i> có bằng chứng thì mới tin.</p>
<p>Ý định dùng <code>bool</code> coi như cũng không có ổn. Bỏ!</p>
<h2><a href="#dùng-bit-array" aria-hidden="true" class="anchor" id="dùng-bit-array"></a>Dùng bit array</h2>
<p>Bản thân một bit có thể chứa được 2 giá trị (<strong>0</strong> và <strong>1</strong>), như vậy là đã thỏa mãn cho yêu cầu của một ma trận hiển thị.</p>
<p>Vậy thì có cách nào chỉ dùng đúng $64 \times 32 = 2048$ bits trong bộ nhớ không? Có!</p>
<p>Rust có hỗ trợ kiểu <code>u64</code> (64-bit unsigned integer), là một kiểu số nguyên không đấu, khi khai báo một biến kiểu này tất nhiên nó sẽ chiếm 64 bits trong bộ nhớ.</p>
<p><img src="img/emulator-64-bit.png" alt="" /></p>
<p>Và nếu chúng ta khai báo một mảng gồm <strong>32</strong> số nguyên <strong>64 bit</strong> <code>[u64; 32]</code> thì sao? Chúng ta sẽ có <strong>2048 bits</strong>! Đủ để chứa toàn bộ ma trận hiển thị.</p>
<p><img src="img/emulator-bit-matrix.png" alt="" /></p>
<p>Đến đây thì vấn đề sẽ là: Làm sao để đọc/ghi vào một bit bất kì của một số <code>u64</code>.</p>
<p><strong>Lưu ý:</strong> về thứ tự cao thấp của các bit, ở đây chúng ta theo quy ước các số đều là big endian, các bit được sắp xếp theo thứ tự từ bit cao đến bit thấp. Ví dụ trong hình sau là một số <code>u16</code> gồm có 2 bytes:</p>
<p><img src="img/highlowbyte.png" alt="" /></p>
<p>Từ trái qua phải, bit đầu tiên gọi là bit cao nhất (highest bit), bit cuối cùng gọi là bit thấp nhất (lowest bit).</p>
<p>Vì thế, khi nói một bit thứ <code>i</code>, chúng ta có thể hiểu là bit thứ <code>i</code> tính từ bit thấp nhất (bên phải) qua <i class='em em-astonished'></i>.</p>
<h2><a href="#đọc-một-bit" aria-hidden="true" class="anchor" id="đọc-một-bit"></a>Đọc một bit</h2>
<p>Để đọc một bit thứ <code>i</code> của một số <code>n</code>, ta dịch phải số <code>n</code> một khoảng bằng <code>i - 1</code> bits, và thực hiện phép <code>AND</code> kết quả thu được với <strong>1</strong>:</p>
<pre class='math'>$$
\texttt{(n >> (i - 1)) & 1}
$$</pre>
<p><strong>Ví dụ:</strong> Để đọc bit thứ 6 của số <strong>0xA1</strong>, ta sử dụng công thức trên qua từng bước như sau:</p>
<p>Số <strong>0xA1</strong> biểu diễn dưới dạng nhị phân là <strong>1010 0001</strong>. Để lấy được bit thứ 6, ta cần dịch phải 5 bit:</p>
<pre class='math'>$$
\texttt{1010 0001 >> 5} = \texttt{0000 0101}
$$</pre>
<p>Tiếp theo, ta thực hiện phép <code>AND</code> kết quả trên với số <strong>1</strong>, thực chất có biểu diễn nhị phân là <strong>0000 0001</strong>:</p>
<pre class='math'>$$
\texttt{0000 0101 & 0000 0001} = \texttt{0000 0001} = \texttt{1}
$$</pre>
<p>Kết quả thu được sẽ là <strong>1</strong>.</p>
<h2><a href="#ghi-một-bit" aria-hidden="true" class="anchor" id="ghi-một-bit"></a>Ghi một bit</h2>
<p>Để ghi giá trị <strong>1</strong> vào bit thứ <code>i</code> của số <code>n</code>, ta dùng phép <code>OR</code> cho số <code>n</code> và kết quả của phép dịch trái số <strong>1</strong> một khoảng <code>i - 1</code> bits:</p>
<pre class='math'>$$
\texttt{n | (1 << (i - 1))}
$$</pre>
<p><strong>Ví dụ:</strong> Để ghi vào bit thứ 4 của số <strong>0xA1</strong>, đầu tiên ta lấy số <strong>1</strong> dịch phải một khoảng 3 bit:</p>
<pre class='math'>$$
\texttt{0000 0001 << 3} = \texttt{0000 1000}
$$</pre>
<p>Sau đó ta thực hiện phép <code>OR</code> kết quả thu được với số <strong>0xA1</strong>:</p>
<pre class='math'>$$
\texttt{1010 0001 | 0000 1000} = \texttt{1010 1001} = \texttt{0xA9}
$$</pre>
<h2><a href="#xóa-một-bit" aria-hidden="true" class="anchor" id="xóa-một-bit"></a>Xóa một bit</h2>
<p>Để xóa một bit thứ <code>i</code> (đưa bit đó về giá trị ban đầu, là <strong>0</strong>) của một số <code>n</code>, ta làm như sau:</p>
<pre class='math'>$$
\texttt{n & !(1 << (i - 1))}
$$</pre>
<p><strong>Ví dụ:</strong> Để chuyển giá trị <strong>0xA9</strong> thu được ở ví dụ trên về lại thành <strong>0xA1</strong>, ta phải xóa bit thứ 4 cua số đó. Tương tự như ở ví dụ trước, đầu tiên ta sẽ dịch trái số <strong>1</strong> một khoảng 3 bit, lần này ta lấy giá trị nghịch đảo <code>NOT</code> của nó.</p>
<pre class='math'>$$
\lnot (\texttt{0000 0001 << 3}) = \lnot (\texttt{0000 1000}) = \texttt{1111 0111}
$$</pre>
<p>Sau đó thực hiện phép <code>AND</code> giữa kết quả thu được và giá trị nhị phân của số <strong>0xA9</strong>:</p>
<pre class='math'>$$
\texttt{1010 1001 & 1111 0111} = \texttt{1010 0001} = \texttt{0xA1}
$$</pre>
<h2><a href="#implement" aria-hidden="true" class="anchor" id="implement"></a>Implement</h2>
<p>Đã thấy lợi hại chưa?</p>
<p>Cá nhân mình thì ko biết nữa, nhưng thấy khá là hại não <i class='em em-astonished'></i> tuy nhiên hiệu quả đem lại thì rất lớn, chúng ta đã tiết kiệm được một lượng lớn bộ nhớ, từ <strong>2KB</strong> xuống còn <strong>2048 bits</strong>.</p>
<p>Bây giờ thì có thể implement thành hàm hay class để dùng lại cho tiện. Ví dụ, đây là hai hàm mình viết để sử dụng trong emulator:</p>
<pre><code class="language-rust">// Lưu ý, code này không có chính xác :v
impl Screen {
  ...
  pub fn set_pixel(&amp;mut self, x: usize, y: usize, on: bool) {
    if on {
      self.display[y] |= 1 &lt;&lt; x;
    } else {
      self.display[y] &amp;= (!(1 &lt;&lt; x));
    }
  }

  pub fn get_pixel(&amp;self, x: usize, y: usize) -&gt; u64 {
    (self.display[y] &gt;&gt; x) &amp; 1
  }
  ...
}
</code></pre>
<hr />
<p>Ngoài việc dùng cho emulator (màn hình trắng đen) ra, thì cách thể hiện ma trận dùng bit array này còn có thể được dùng cho nhiều trường hợp khác như bảng đèn điện tử (tín hiệu bật/tắt), lưu các đỉnh của một đồ thị, lưu bàn cờ hoặc các thể loại map đơn giản nếu bạn làm game, hoặc có thể cải tiến để sử dụng từng byte thay vì từng bit để lưu trữ được nhiều thông tin hơn.</p>
<p>Hy vọng qua bài viết này, mình đã ít nhiều chia sẽ được cho các bạn chút gì đó, mặc dù cho đến thời điểm này mình vẫn chưa biết là mình đã chia sẽ được gì <i class='em em-grin'></i></p>
<p>Cảm ơn các bạn đã kiên nhẫn đọc đến tận những dòng này. Nếu các bạn cảm thấy bài viết này thú vị, đừng ngại để lại comment, và nhớ <a href="http://eepurl.com/cN5YDv">subscribe vào mailing list</a> của mình để nhận thông báo về các bài viết mới, hoặc <a href="https://facebook.com/thefullsnackblog">like trang Facebook</a> để đọc những dòng status ất ơ ngẫu nhiên của mình vào một ngày đẹp trời nào đó. Chào thân ái và quyết thắng.</p>
<div class='other-tags'><b>Tags:</b> <a class='topic-tag' href='../tags/emulator.html'>emulator</a><a class='topic-tag' href='../tags/javascript.html'>javascript</a><a class='topic-tag' href='../tags/bitwise.html'>bitwise</a><a class='topic-tag' href='../tags/rust.html'>rust</a><a class='topic-tag' href='../tags/hacking.html'>hacking</a><a class='topic-tag' href='../tags/hardware.html'>hardware</a><a class='topic-tag' href='../tags/game.html'>game</a><a class='topic-tag' href='../tags/math.html'>math</a></div>
<div class="related-posts" style="margin-top: 15px; border-bottom: 1px solid #eee;">
<p><i class="em em-sun_with_face"></i> Cảm ơn bạn đã theo dõi bài viết! các bạn có thể <a href="https://facebook.com/thefullsnackblog" target="_blank">follow mình trên Facebook</a> để đặt câu hỏi, hoặc nhận thông tin về các bài viết mới.</p>
</div>
<div class="comments">
<ul id="comment-list" class="comment-list"></ul>
<div id="login-box" class="login">
Bạn nghĩ như thế nào về bài viết này?<br /><button onclick="login()">Tham gia bình luận</button>
<div class="copyright">Chức năng này cần liên kết với tài khoản Google<br />Nếu không thích thì có thể comment <button onclick="goninja()">Nặc danh</button></div>
</div>
<div id="comment-box" class="comment-input">
<div class="avatar">
<img id="user-avatar" src="#" width="32" height="32" />
</div>
<div class="input">
<textarea id="comment-content" onkeydown="submitComment(event)" placeholder="Comment gõ vào đây :D"></textarea>
<span>Gõ xong nhấn <kbd>Ctrl</kbd> + <kbd>Enter</kbd> để gửi. Bạn không thể xóa comment sau khi gửi.</span>
<button id="comment-button" onclick="submitData()">Gửi</button>
</div>
</div>
</div>
</div>
</div>
<div class="footer lightweight-theme">
<p>you're free to use the content on this blog for whatever you want</p>
<p>Created with <i class="em em-coffee"></i> <a href="https://github.com/huytd/ristretto-rs">ristretto.rs</a></p>
</div>
<script src="../js/highlight.pack.js"></script>
<script>
        </script>
<script type="text/javascript" async src="../../cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJaxb198.js?config=TeX-MML-AM_CHTML"></script>
<script type="text/x-mathjax-config">
         MathJax.Hub.Config({
             tex2jax: {
                 inlineMath: [['$','$'], ['\\(','\\)']],
                 skipTags: ["script","noscript","style","textarea", "code"],
                 ignoreClass: "tex2jax_ignore|comment|comment-list|content"
             }
         });
        </script>
<script src="../js/toc.js"></script>
<script src="../../www.gstatic.com/firebasejs/3.8.0/firebase.js"></script>
<script>
         let postCommentURL = '../api/post/matrix-representation.json';
         // Initialize Firebase
         var config = {
             apiKey: "AIzaSyA1PnIAlJJ-U6iQJMNnCOknBuziBqGMYcY",
             authDomain: "huys-blog-comment.firebaseapp.com",
             databaseURL: "https://huys-blog-comment.firebaseio.com",
             projectId: "huys-blog-comment",
             storageBucket: "huys-blog-comment.appspot.com",
             messagingSenderId: "317330376829"
         };

         var login = function() {
             window.auth.signInWithPopup(provider)
                   .then(function(result) {
                   }).catch(function(err) {
                   });
         };

         var goninja = function() {
             updateAuth({
                 displayName: "Không Tên",
                 photoURL: "https://thefullsnack.com/img/kaonashi.jpg"
             });
         };

         var updateAuth = function(user) {
             if (user) {
                 currentUser = user;
                 // Logged in
                 document.getElementById("login-box").style.display = "none";
                 document.getElementById("comment-box").style.display = "flex";
                 document.getElementById("user-avatar").setAttribute("src", user.photoURL + "?sz=32");
             } else {
                 // Not login yet
                 document.getElementById("comment-box").style.display = "none";
                 document.getElementById("login-box").style.display = "block";
             }
         };

         var encodeHTML = function(s) {
             return s.replace(/</g, '&lt;').replace(/"/g, '&quot;').replace(/>/g, '&gt;');
         };

         var saveNewComment = function(comment) {
             if (!currentUser) {
                 return;
             }
             var commentData = {
                 username: currentUser.displayName,
                 avatar: currentUser.photoURL,
                 post_time: ~~((new Date()).getTime() / 1000),
                 message: encodeHTML(comment)
             };

             fetch(postCommentURL, {
                 method: 'post',
                 headers: {
                     "Content-Type": "application/json"
                 },
                 body: JSON.stringify(commentData)
             }).then((result) => {
                 if (result.status === 200) {
                     addNewComment(commentData.username, commentData.avatar, commentData.post_time, commentData.message);
                 }
             });

             document.getElementById("comment-content").value = "";
         };

         function debounce(func, wait, immediate) {
             var timeout;
             return function() {
                 var context = this, args = arguments;
                 var later = function() {
                     timeout = null;
                     if (!immediate) func.apply(context, args);
                 };
                 var callNow = immediate && !timeout;
                 clearTimeout(timeout);
                 timeout = setTimeout(later, wait);
                 if (callNow) func.apply(context, args);
             };
         };

         var submitData = debounce(function() {
             var comment = document.getElementById("comment-content").value;
             if (comment.length) {
                 saveNewComment(comment);
             }
         }, 250);

         var submitComment = function(e) {
             var keyCode = e.which || e.keyCode;
             var ctrlCode = e.ctrlKey || e.metaKey;
             if (keyCode === 13 && ctrlCode) {
                 submitData();
             }
         };

         var filterNewlineInComment = function(t) {
             return t.replace(/\n/g, "<br/>");
         };

         var filterURLinComment = function(comment) {
             return comment.replace(/(https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9]\.[^\s]{2,})/g, "<a target='_blank' rel='noopener noreferrer' href='$1'>$1</a>");
         };

         var addNewComment = function(user, avatar, time, comment, first) {
             var commentFiltered = encodeHTML(comment);
             commentFiltered = filterNewlineInComment(filterURLinComment(commentFiltered));
             commentFiltered = commentFiltered.replace(/```/g, '');
             var d = new Date(time * 1000);
             var commentTime = d.toLocaleTimeString() + ' ' + d.toLocaleDateString();
             var anoNameClass = (avatar.indexOf('thefullsnack.com') !== -1) ? "grey" : "";
             var html = '<div class="avatar">' +
                        '   <img src="' + avatar + '?sz=32" width="32" height="32"/>' +
                        ' </div>' +
                        '<div class="comment">' +
                        '  <div class="metadata"><b class="' + anoNameClass + '">' + encodeHTML(user) + '</b> lúc <span>' + commentTime + '</span></div>' +
                        '  <div class="content tex2jax_ignore">' + commentFiltered
             '  </div>' +
                        '</div>';
             var li = document.createElement('li');
             li.innerHTML = html;
             if (!first) {
                 document.getElementById("comment-list").append(li);
             } else {
                 let elm = document.getElementById("comment-list");
                 elm.insertBefore(li, elm.firstChild);
             }
         };



         window.onload = function() {

             document.querySelectorAll("pre code").forEach(el => {
                 hljs.highlightBlock(el);
             });

             start_toc_module();

             firebase.initializeApp(config);
             window.provider = new firebase.auth.GoogleAuthProvider();
             window.auth = firebase.auth();
             window.currentUser = null;

             window.auth.onAuthStateChanged(function(user) {
                 updateAuth(user);
             });


             // Fetch comment and put to posts
             fetch(postCommentURL)
                 .then(res => res.json())
                 .then(data => {
                     if (data.comments) {
                         let comments = data.comments;
                         comments.sort((a, b) => a.post_time - b.post_time);
                         for (let i = 0; i < comments.length; i++) {
                             let cmt = comments[i];
                             addNewComment(cmt.username, cmt.avatar, cmt.post_time, cmt.message);
                         }
                     }
                 });
         };

         var toggle_wordwise = function(status) {
             var book = document.querySelector("book");
             var on = document.querySelector("#ww_on");
             var off = document.querySelector("#ww_off");
             if (!status) {
                 book.className = "off";
                 on.className = "btn-toggle";
                 off.className = "btn-toggle active";
             } else {
                 book.className = "";
                 on.className = "btn-toggle active";
                 off.className = "btn-toggle";
             }
         };
        </script>
</body>

<!-- Mirrored from thefullsnack.com/posts/matrix-representation.html by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 12 May 2020 03:19:59 GMT -->
</html>
