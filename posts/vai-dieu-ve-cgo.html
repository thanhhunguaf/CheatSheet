<html>

<!-- Mirrored from thefullsnack.com/posts/vai-dieu-ve-cgo.html by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 12 May 2020 03:21:57 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf8" /><!-- /Added by HTTrack -->
<head>
<title>Kinh nghiệm làm việc với Cgo | Huy's Blog</title>
<meta charset="utf-8">
<meta http-equiv="content-type" content="text/html;"><meta name=viewport content="initial-scale=1.0 maximum-scale=1.0">
<meta property='og:image' content='../img/default.jpg'>
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="manifest" href="../manifest.json">
<link rel="mask-icon" href="../safari-pinned-tab.svg" color="#5bbad5">
<meta name="theme-color" content="#ffffff">
<link href="../css/theme.dist.css" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="../emoji/css/emoji.dist.css">
<link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700|Space+Mono:400,700&amp;display=swap&amp;subset=vietnamese" rel="stylesheet">

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-92158965-1"></script>
<script>
	       window.dataLayer = window.dataLayer || [];
	       function gtag(){dataLayer.push(arguments);}
	       gtag('js', new Date());

	       gtag('config', 'UA-92158965-1');
	      </script>
</head>
<body lang="en" class="post">
<div class="header lightweight-theme">
<a href="../index.html"><span class="avatar"></span></a>
</div>
<div class="container">
<div class="main">
<h1><span>Kinh nghiệm làm việc với Cgo</span></h1>
<p>Cuối tuần vừa rồi mình có làm một project nho nhỏ để học hỏi thêm, điểm khá thú vị là project này tuy không to lắm nhưng lại chứa khá là nhiều vấn đề và buộc mình phải tìm hiểu sâu vào rất nhiều mảng kĩ thuật.</p>
<p>Một trong những chức năng của project này là việc chụp ảnh màn hình (screenshot), cũng nhờ vậy mà biết được việc chụp ảnh màn hình trên từng hệ điều hành khác nhau là một công việc không hề đơn giản và chắc chắn không thể thực hiện trực tiếp trong Golang mà phải thông qua API của từng hệ điều hành, chính vì vậy nên cần phải đụng tới Cgo. Chi tiết về việc chụp ảnh chắc mình sẽ viết ở một bài viết khác, bài này mình chia sẽ một vài điều rút ra khi làm việc với Cgo trong 2 ngày cuối tuần vừa rồi.</p>
<h2><a href="#giới-thiệu-nhanh-về-cgo" aria-hidden="true" class="anchor" id="giới-thiệu-nhanh-về-cgo"></a>Giới thiệu nhanh về Cgo</h2>
<p>Cgo tức là C kết hợp với Go, nói đơn giản thì Cgo giúp cho Go có thể gọi được code C và ngược lại, gọi code C trong Go... à nhầm, gọi code Go trong C.</p>
<p>Để gọi được code C trong Go thì chúng ta viết đoạn code C đó trong một khối comment <code>/* */</code> hoặc <code>//</code> rồi import gói <code>&quot;C&quot;</code>. Trình biên dịch sẽ tự động chia ra, gọi <code>gcc</code> (hoặc trình biên dịch C default của máy tính) để biên dịch đoạn code trên, sau đó go compiler sẽ làm nhiệm vụ liên kết nó vào chương trình.</p>
<p>Chúng ta có thể truy cập vào C code thông qua đối tượng <code>C</code> trong Go, ví dụ:</p>
<pre><code>package main

/*
#include &lt;stdio.h&gt;

void sayHello() {
  printf(&quot;YOLO!&quot;)
}
*/
import &quot;C&quot;

func main() {
  C.sayHello()
}
</code></pre>
<p>Nếu muốn tìm hiểu chi tiết hơn về Cgo các bạn có thể tham khảo các link ở cuối bài.</p>
<p>Sau đây mình sẽ nói sơ về một vài kinh nghiệm mình gặp phải trong quá trình làm việc với nó.</p>
<h2><a href="#cygwin-không-tương-thích-với-cgo" aria-hidden="true" class="anchor" id="cygwin-không-tương-thích-với-cgo"></a>Cygwin không tương thích với Cgo</h2>
<p>Nếu dùng Windows hẳn các bạn sẽ dùng Cygwin, và trình biên dịch <code>gcc</code> đi kèm của Cygwin thì không có khả năng biên dịch được Cgo.</p>
<p>Để làm việc với Cgo trên Windows bạn bắt buộc phải sử dụng Command Line của win, và biên dịch bằng MingGW.</p>
<h2><a href="#cgo-không-chỉ-có-c" aria-hidden="true" class="anchor" id="cgo-không-chỉ-có-c"></a>Cgo không chỉ có C</h2>
<p>Nếu làm việc trên Mac, bạn còn có thể dùng Cgo để gọi code Objective-C và xài các framework của Objective-C như Cocoa ngay trong Go luôn cũng được, ví dụ:</p>
<pre><code>/*
#cgo CFLAGS: -x objective-c
#cgo LDFLAGS: -framework Cocoa -framework Foundation
#import &lt;Cocoa/Cocoa.h&gt;
#import &lt;Foundation/Foundation.h&gt;

...
*/
</code></pre>
<h2><a href="#memory-leak-từ-phía-c" aria-hidden="true" class="anchor" id="memory-leak-từ-phía-c"></a>Memory Leak từ phía C</h2>
<p>Go có garbage collector (GC), và GC của Go hoạt động trong lúc runtime luôn. Nhưng C thì không như vậy. Điều này có nghĩa là khi làm khởi tạo các object bên trong phần C, bạn phải quản lý chúng bằng tay (tạo ra thì nhớ hủy nó đi), nếu không thì memleak sẽ là một vấn đề đau đầu.</p>
<p>Cách đơn giản nhất để phát hiện memleak là dùng Task Manager của Windows hoặc Activity Monitor của Mac theo dõi bộ nhớ sử dụng của chương trình, nếu code logic của bạn không làm gì nhiều nhưng memory cứ tăng lên liên tục, thì khả năng đó là nó đang bị leak.</p>
<h2><a href="#thời-gian-build-chậm-hơn" aria-hidden="true" class="anchor" id="thời-gian-build-chậm-hơn"></a>Thời gian build chậm hơn</h2>
<p>Rõ ràng rồi, thay vì chỉ có Go compiler biên dịch chương trình của bạn, thì lần này trong build process phải chạy đến 2 compiler (GCC và Go compiler) biên dịch 2 lần code và link chúng lại với nhau.</p>
<h2><a href="#vấn-đề-dependencies-khi-deploy" aria-hidden="true" class="anchor" id="vấn-đề-dependencies-khi-deploy"></a>Vấn đề dependencies khi deploy</h2>
<p>Nếu dùng Cgo, khi user cài đặt chương trình Go của bạn thì trên máy tính của họ ngoài các thư viện mà Go phụ thuộc ra, họ còn phải cài đặt thêm các thư viện mà phần code C của bạn cần dùng tới. Điều này sẽ khiến cho việc deployment tốn thêm vài bước nữa để đảm bảo chương trình chạy tốt.</p>
<p>Èo, tạm thời tuần này mình chỉ ghi ra được một vài ý đơn giản vậy, còn nhiều thứ nữa nhưng mà giờ chưa hệ thống lại để diễn đạt một cách gọn gàng đường, chắc phải hẹn tuần sau thôi :D Nhưng kết luận là: Cgo là một chức năng khá hay và quan trọng của Go, giúp mở rộng Go để có thể sử dụng sức mạnh của nhiều công nghệ khác, nhưng bất cứ thứ công nghệ nào cũng đều có 2 mặt, thứ gì càng hay thì càng cần phải tìm hiểu rõ về nó để biết khi nào cần xài, khi nào thì nên tránh. Đúng với câu nói vui của một anh bạn mình:</p>
<blockquote>
<p>Hiểu để xài nhau tốt hơn</p>
</blockquote>
<p>Chốt bài viết mình xin dẫn một vài link nên đọc về Cgo cho bạn nào muốn tìm hiểu sâu thêm về nó:</p>
<p><a href="https://blog.golang.org/c-go-cgo">[1] Go Blog - C? Go? Cgo!</a></p>
<p><a href="https://golang.org/cmd/cgo/">[2] Godoc - Command cgo</a></p>
<p><a href="https://github.com/golang/go/wiki/cgo">[3] Wiki Cgo</a></p>
<p><a href="http://dave.cheney.net/2016/01/18/cgo-is-not-go">[4] Blog của bác Dave Cheney - Cgo is not Go</a></p>
<p><a href="https://www.cockroachlabs.com/blog/the-cost-and-complexity-of-cgo/">[5] Cockroach Labs - The Cost and Complexity of Cgo</a></p>
<div class='other-tags'><b>Tags:</b> <a class='topic-tag' href='../tags/code.html'>code</a><a class='topic-tag' href='../tags/c.html'>c</a><a class='topic-tag' href='../tags/go.html'>go</a></div>
<div class="related-posts" style="margin-top: 15px; border-bottom: 1px solid #eee;">
<p><i class="em em-sun_with_face"></i> Cảm ơn bạn đã theo dõi bài viết! các bạn có thể <a href="https://facebook.com/thefullsnackblog" target="_blank">follow mình trên Facebook</a> để đặt câu hỏi, hoặc nhận thông tin về các bài viết mới.</p>
</div>
<div class="comments">
<ul id="comment-list" class="comment-list"></ul>
<div id="login-box" class="login">
Bạn nghĩ như thế nào về bài viết này?<br /><button onclick="login()">Tham gia bình luận</button>
<div class="copyright">Chức năng này cần liên kết với tài khoản Google<br />Nếu không thích thì có thể comment <button onclick="goninja()">Nặc danh</button></div>
</div>
<div id="comment-box" class="comment-input">
<div class="avatar">
<img id="user-avatar" src="#" width="32" height="32" />
</div>
<div class="input">
<textarea id="comment-content" onkeydown="submitComment(event)" placeholder="Comment gõ vào đây :D"></textarea>
<span>Gõ xong nhấn <kbd>Ctrl</kbd> + <kbd>Enter</kbd> để gửi. Bạn không thể xóa comment sau khi gửi.</span>
<button id="comment-button" onclick="submitData()">Gửi</button>
</div>
</div>
</div>
</div>
</div>
<div class="footer lightweight-theme">
<p>you're free to use the content on this blog for whatever you want</p>
<p>Created with <i class="em em-coffee"></i> <a href="https://github.com/huytd/ristretto-rs">ristretto.rs</a></p>
</div>
<script src="../js/highlight.pack.js"></script>
<script>
        </script>
<script type="text/javascript" async src="../../cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJaxb198.js?config=TeX-MML-AM_CHTML"></script>
<script type="text/x-mathjax-config">
         MathJax.Hub.Config({
             tex2jax: {
                 inlineMath: [['$','$'], ['\\(','\\)']],
                 skipTags: ["script","noscript","style","textarea", "code"],
                 ignoreClass: "tex2jax_ignore|comment|comment-list|content"
             }
         });
        </script>
<script src="../js/toc.js"></script>
<script src="../../www.gstatic.com/firebasejs/3.8.0/firebase.js"></script>
<script>
         let postCommentURL = '../api/post/vai-dieu-ve-cgo.json';
         // Initialize Firebase
         var config = {
             apiKey: "AIzaSyA1PnIAlJJ-U6iQJMNnCOknBuziBqGMYcY",
             authDomain: "huys-blog-comment.firebaseapp.com",
             databaseURL: "https://huys-blog-comment.firebaseio.com",
             projectId: "huys-blog-comment",
             storageBucket: "huys-blog-comment.appspot.com",
             messagingSenderId: "317330376829"
         };

         var login = function() {
             window.auth.signInWithPopup(provider)
                   .then(function(result) {
                   }).catch(function(err) {
                   });
         };

         var goninja = function() {
             updateAuth({
                 displayName: "Không Tên",
                 photoURL: "https://thefullsnack.com/img/kaonashi.jpg"
             });
         };

         var updateAuth = function(user) {
             if (user) {
                 currentUser = user;
                 // Logged in
                 document.getElementById("login-box").style.display = "none";
                 document.getElementById("comment-box").style.display = "flex";
                 document.getElementById("user-avatar").setAttribute("src", user.photoURL + "?sz=32");
             } else {
                 // Not login yet
                 document.getElementById("comment-box").style.display = "none";
                 document.getElementById("login-box").style.display = "block";
             }
         };

         var encodeHTML = function(s) {
             return s.replace(/</g, '&lt;').replace(/"/g, '&quot;').replace(/>/g, '&gt;');
         };

         var saveNewComment = function(comment) {
             if (!currentUser) {
                 return;
             }
             var commentData = {
                 username: currentUser.displayName,
                 avatar: currentUser.photoURL,
                 post_time: ~~((new Date()).getTime() / 1000),
                 message: encodeHTML(comment)
             };

             fetch(postCommentURL, {
                 method: 'post',
                 headers: {
                     "Content-Type": "application/json"
                 },
                 body: JSON.stringify(commentData)
             }).then((result) => {
                 if (result.status === 200) {
                     addNewComment(commentData.username, commentData.avatar, commentData.post_time, commentData.message);
                 }
             });

             document.getElementById("comment-content").value = "";
         };

         function debounce(func, wait, immediate) {
             var timeout;
             return function() {
                 var context = this, args = arguments;
                 var later = function() {
                     timeout = null;
                     if (!immediate) func.apply(context, args);
                 };
                 var callNow = immediate && !timeout;
                 clearTimeout(timeout);
                 timeout = setTimeout(later, wait);
                 if (callNow) func.apply(context, args);
             };
         };

         var submitData = debounce(function() {
             var comment = document.getElementById("comment-content").value;
             if (comment.length) {
                 saveNewComment(comment);
             }
         }, 250);

         var submitComment = function(e) {
             var keyCode = e.which || e.keyCode;
             var ctrlCode = e.ctrlKey || e.metaKey;
             if (keyCode === 13 && ctrlCode) {
                 submitData();
             }
         };

         var filterNewlineInComment = function(t) {
             return t.replace(/\n/g, "<br/>");
         };

         var filterURLinComment = function(comment) {
             return comment.replace(/(https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9]\.[^\s]{2,})/g, "<a target='_blank' rel='noopener noreferrer' href='$1'>$1</a>");
         };

         var addNewComment = function(user, avatar, time, comment, first) {
             var commentFiltered = encodeHTML(comment);
             commentFiltered = filterNewlineInComment(filterURLinComment(commentFiltered));
             commentFiltered = commentFiltered.replace(/```/g, '');
             var d = new Date(time * 1000);
             var commentTime = d.toLocaleTimeString() + ' ' + d.toLocaleDateString();
             var anoNameClass = (avatar.indexOf('thefullsnack.com') !== -1) ? "grey" : "";
             var html = '<div class="avatar">' +
                        '   <img src="' + avatar + '?sz=32" width="32" height="32"/>' +
                        ' </div>' +
                        '<div class="comment">' +
                        '  <div class="metadata"><b class="' + anoNameClass + '">' + encodeHTML(user) + '</b> lúc <span>' + commentTime + '</span></div>' +
                        '  <div class="content tex2jax_ignore">' + commentFiltered
             '  </div>' +
                        '</div>';
             var li = document.createElement('li');
             li.innerHTML = html;
             if (!first) {
                 document.getElementById("comment-list").append(li);
             } else {
                 let elm = document.getElementById("comment-list");
                 elm.insertBefore(li, elm.firstChild);
             }
         };



         window.onload = function() {

             document.querySelectorAll("pre code").forEach(el => {
                 hljs.highlightBlock(el);
             });

             start_toc_module();

             firebase.initializeApp(config);
             window.provider = new firebase.auth.GoogleAuthProvider();
             window.auth = firebase.auth();
             window.currentUser = null;

             window.auth.onAuthStateChanged(function(user) {
                 updateAuth(user);
             });


             // Fetch comment and put to posts
             fetch(postCommentURL)
                 .then(res => res.json())
                 .then(data => {
                     if (data.comments) {
                         let comments = data.comments;
                         comments.sort((a, b) => a.post_time - b.post_time);
                         for (let i = 0; i < comments.length; i++) {
                             let cmt = comments[i];
                             addNewComment(cmt.username, cmt.avatar, cmt.post_time, cmt.message);
                         }
                     }
                 });
         };

         var toggle_wordwise = function(status) {
             var book = document.querySelector("book");
             var on = document.querySelector("#ww_on");
             var off = document.querySelector("#ww_off");
             if (!status) {
                 book.className = "off";
                 on.className = "btn-toggle";
                 off.className = "btn-toggle active";
             } else {
                 book.className = "";
                 on.className = "btn-toggle active";
                 off.className = "btn-toggle";
             }
         };
        </script>
</body>

<!-- Mirrored from thefullsnack.com/posts/vai-dieu-ve-cgo.html by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 12 May 2020 03:21:58 GMT -->
</html>
