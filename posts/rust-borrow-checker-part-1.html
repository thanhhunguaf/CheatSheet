<html>

<!-- Mirrored from thefullsnack.com/posts/rust-borrow-checker-part-1.html by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 12 May 2020 03:19:40 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf8" /><!-- /Added by HTTrack -->
<head>
<title>Đừng đánh nhau với borrow checker | Huy's Blog</title>
<meta charset="utf-8">
<meta http-equiv="content-type" content="text/html;"><meta name=viewport content="initial-scale=1.0 maximum-scale=1.0">
<meta property='og:image' content='../img/default.jpg'>
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="manifest" href="../manifest.json">
<link rel="mask-icon" href="../safari-pinned-tab.svg" color="#5bbad5">
<meta name="theme-color" content="#ffffff">
<link href="../css/theme.dist.css" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="../emoji/css/emoji.dist.css">
<link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700|Space+Mono:400,700&amp;display=swap&amp;subset=vietnamese" rel="stylesheet">

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-92158965-1"></script>
<script>
	       window.dataLayer = window.dataLayer || [];
	       function gtag(){dataLayer.push(arguments);}
	       gtag('js', new Date());

	       gtag('config', 'UA-92158965-1');
	      </script>
</head>
<body lang="en" class="post">
<div class="header lightweight-theme">
<a href="../index.html"><span class="avatar"></span></a>
</div>
<div class="container">
<div class="main">
<h1><span>Đừng đánh nhau với borrow checker</span></h1>
<p><strong>TL;DR:</strong> Đừng bao giờ đánh nhau với borrow checker, nó được sinh ra để bạn phải phục tùng nó <i class='em em-sob'></i></p>
<p><img src="img/borrow-checker-001.png" alt="" /></p>
<p>Một trong những cơn ác mộng của lập trình viên khi làm việc với Rust đó là chuyện đập nhau với borrow checker, ví dụ như những lúc bị compiler chửi vào mặt như thế này.</p>
<pre><code class="language-rust">fn main() {
    let a = vec![5];
    let b = a;
    println!(&quot;{:?}&quot;, a);
}
</code></pre>
<pre><code class="language-rust">error[E0382]: use of moved value: `a`
 --&gt; borrowchecker.rs:4:22
  |
3 |     let b = a;
  |         - value moved here
4 |     println!(&quot;{:?}&quot;, a);
  |                      ^ value used here after move
  |
  = note: move occurs because `a` has type `std::vec::Vec&lt;i32&gt;`, which does not implement the `Copy` trait
</code></pre>
<p>Chỉ với một câu lệnh gán thông thường, chúng ta đã bị ăn lỗi.</p>
<p>Và trong hầu hết mọi trường hợp thì kẻ có lỗi chính là các lập trình viên <i class='em em-joy'></i> Borrow checker cũng chưa bao giờ đập ai (nó chỉ đứng đó và chửi vô mặt người ta thôi). Lỗi ở đây chính là vì chúng ta không hiểu về mô hình quản lý bộ nhớ của Rust, và các quy tắc mà ngôn ngữ lập trình này đặt ra.</p>
<p>Vậy Rust kiểm soát bộ nhớ như thế nào? Và làm sao để chúng ta có thể làm vừa lòng Rust compiler trong những trường hợp như thế này?</p>
<p>Bài viết này sẽ giúp các bạn hiểu được chuyện đó thông qua hai vấn đề chính: <strong>Ownership</strong> (quyền sở hữu của một biến) và <strong>Borrowing</strong> (vay mượn/tham chiếu giữa các biến).</p>
<h2><a href="#ownership" aria-hidden="true" class="anchor" id="ownership"></a>Ownership</h2>
<p>Trong máy tính, bộ nhớ (memory) là từ dùng để chỉ các ô nằm liền kề nhau để lưu trữ thông tin.</p>
<p><img src="img/borrow-checker-002.png" alt="" /></p>
<p>Khi chúng ta khai báo một biến mới trong Rust, một vùng nhớ sẽ được cấp phát trong bộ nhớ, và nó sẽ mọc thêm mắt mũi chân càng như thế này:</p>
<p><img src="img/borrow-checker-003.png" alt="" /></p>
<p>Just kididng <i class='em em-joy'></i> một biến <code>a</code> khi được khai báo, máy tính sẽ cấp phát một vùng nhớ trên stack, với giá trị mặc định là giá trị được truyền vào khi khai báo. Địa chỉ của vùng nhớ này sẽ được gán cho biến <code>a</code>.</p>
<p>Khi đó ta có thể coi là: vùng nhớ này thuộc về biến <code>a</code>, và <code>a</code> có quyền sở hữu (ownership) đối với vùng nhớ đó.</p>
<p>Một vùng nhớ tại một thời điểm chỉ có thể thuộc về duy nhất một biến. Và điều gì xảy ra nếu ta gán một biến vào một biến khác?</p>
<p><img src="img/borrow-checker-005.png" alt="" /></p>
<p>Quyền sở hữu vùng nhớ của biến này sẽ được chuyển sang biến khác, ở ví dụ trên ta khai báo biến <code>a</code> là một <code>vector</code>, sau đó gán biến <code>a</code> cho <code>b</code>, lúc này vùng nhớ mà biến <code>a</code> sở hữu đã được chuyển (move) sang cho <code>b</code>.</p>
<p>Nếu ngay sau đó chúng ta tìm cách đọc biến <code>a</code> thì sẽ gặp lỗi, vì không còn mang giá trị nào để có thể đọc được nữa.</p>
<pre><code class="language-rust">error[E0382]: use of moved value: `a`
  |
3 |     let b = a;
  |         - value moved here
4 |     println!(&quot;{:?}&quot;, a);
  |                      ^ value used here after move
  |
</code></pre>
<p>Để tránh việc giá trị của một biến bị moved sau khi thực hiện phép gán, ta có thể implement trait <a href="https://doc.rust-lang.org/std/marker/trait.Copy.html">Copy</a> cho kiểu dữ liệu của biến đó.</p>
<pre><code class="language-rust">#[derive(Copy, Clone)]
struct Point {
  x: i32,
  y: i32
}
</code></pre>
<p>Chức năng của <code>Copy</code> trait đúng với tên gọi của nó, khi phép gán xảy ra, thì thay vì move giá trị của biến này sang biến khác, Rust runtime sẽ copy giá trị đó. Và sau phép gán, cả 2 biến vẫn có thể được sử dụng một cách bình thường.</p>
<p><img src="img/borrow-checker-006.png" alt="" /></p>
<p>Một số kiểu dữ liệu như <code>i32</code> thường được implement sẵn trait này. Để biết kiểu dữ liệu mình tính xài được implement sẵn những trait nào thì bạn có thể xem trong phần <a href="https://doc.rust-lang.org/std/primitive.i32.html#implementations">Trait Implementations</a> của kiểu dữ liệu đó.</p>
<h2><a href="#borrowing" aria-hidden="true" class="anchor" id="borrowing"></a>Borrowing</h2>
<p>Sao Rust compiler khó tánh dữ vậy? Giá trị của một biến thì thuộc quyền sở hữu của biến đó à? Vậy làm sao để truyền dữ liệu qua lại giữa các biến? Lỡ kiểu dữ liệu tui xài hổng có implement trait <code>Copy</code> thì làm sao?</p>
<p>Đến đây thì chúng ta bắt gặp một vấn đề rất là đời thường, xin nhắc lại, mặc dù Rust là một ngôn ngữ lập trình nhưng nó luôn phản ánh đúng với thực trạng của xã hội, đây là vấn đề thường ngày trong chuyện giao tiếp giữa người với người, vâng, rất nhân văn: <strong>Muốn xài đồ của người khác thì tất nhiên phải đi mượn</strong> (borrow).</p>
<p><img src="img/borrow-checker-007.png" alt="" /></p>
<p>Để mượn một giá trị trong Rust rất dễ, chúng ta chỉ cần đặt dấu <code>&amp;</code> vào trước biến cần mượn. Ví dụ:</p>
<pre><code class="language-rust">let b = &amp;a;
</code></pre>
<p>Và tất nhiên khi đem cho mượn, giá trị của một biến vẫn thuộc quyền sở hữu của biến đó, Rust chỉ tạo một <strong>tham chiếu</strong> (references) đến vùng nhớ chứa giá trị này, chứ không move nó đi chỗ khác. Chính vì vậy, một biến có thể cho mượn bao nhiêu lần tùy ý. Nhưng với một điều kiện, đó là <strong>các tham chiếu đến giá trị của biến đó là readonly</strong>. Tức là không ai có thể thay đổi được giá trị của biến, trừ chính biến đó.</p>
<p><img src="img/borrow-checker-008.png" alt="" /></p>
<p>Cũng giống như khi bạn cho ai mượn ví tiền của bạn chỉ để xem cái ví như thế nào thôi, thì người ta không có quyền lấy tiền từ ví của bạn. Nhưng với vợ bạn thì sẽ khác... <i class='em em-sob'></i></p>
<p>Vợ bạn có thể dùng <code>&amp;mut</code> để <strong>vừa mượn vừa thay đổi được</strong> số tiền trong ví của bạn.</p>
<p><img src="img/borrow-checker-009.png" alt="" /></p>
<p><strong>Lưu ý:</strong> Có thể bạn biết rồi, trong Rust, mọi giá trị được khai báo đều là <strong>immutable</strong>, nghĩa là không thể thay đổi được. Vì thế một biến được khai báo theo cách thông thường thì cũng <strong>immutable</strong> nốt. Nếu ta mượn một biến immutable để ghi (mutate nó) thì sẽ bị ăn lỗi:</p>
<pre><code class="language-rust">error[E0596]: cannot borrow immutable local variable `a` as mutable
 --&gt; borrowchecker.rs:3:18
  |
2 |     let a = 10;
  |         - consider changing this to `mut a`
3 |     let b = &amp;mut a;
  |                  ^ cannot borrow mutably
</code></pre>
<p>Để không phải đau đầu với chuyện mượn/trả, moving của các biến, chúng ta có các quy tắc cần nhớ sau:</p>
<ul>
<li>Một biến sau khi được gán thì không dùng được nữa (bị moved)</li>
<li>Muốn dùng một biến sau khi gán thì có thể borrow nó, hoặc implement <code>Copy</code> trait cho kiểu dữ liệu của nó</li>
<li>Một biến có thể được mượn để đọc (immutable borrow) không giới hạn số lần</li>
<li>Chỉ có duy nhất một lần mượn để ghi (mutable borrow) tại một thời điểm</li>
</ul>
<hr />
<p>Tạm thời viết chừng này đã, bài này nằm trong thư mục draft lâu quá rồi <i class='em em-think-cry'></i>. Ở phần tiếp theo chúng ta sẽ tiếp tục tìm hiểu sang khái niệm còn lại, đó là <code>Lifetime</code>.</p>
<div class='other-tags'><b>Tags:</b> <a class='topic-tag' href='../tags/rust.html'>rust</a></div>
<div class="related-posts" style="margin-top: 15px; border-bottom: 1px solid #eee;">
<p><i class="em em-sun_with_face"></i> Cảm ơn bạn đã theo dõi bài viết! các bạn có thể <a href="https://facebook.com/thefullsnackblog" target="_blank">follow mình trên Facebook</a> để đặt câu hỏi, hoặc nhận thông tin về các bài viết mới.</p>
</div>
<div class="comments">
<ul id="comment-list" class="comment-list"></ul>
<div id="login-box" class="login">
Bạn nghĩ như thế nào về bài viết này?<br /><button onclick="login()">Tham gia bình luận</button>
<div class="copyright">Chức năng này cần liên kết với tài khoản Google<br />Nếu không thích thì có thể comment <button onclick="goninja()">Nặc danh</button></div>
</div>
<div id="comment-box" class="comment-input">
<div class="avatar">
<img id="user-avatar" src="#" width="32" height="32" />
</div>
<div class="input">
<textarea id="comment-content" onkeydown="submitComment(event)" placeholder="Comment gõ vào đây :D"></textarea>
<span>Gõ xong nhấn <kbd>Ctrl</kbd> + <kbd>Enter</kbd> để gửi. Bạn không thể xóa comment sau khi gửi.</span>
<button id="comment-button" onclick="submitData()">Gửi</button>
</div>
</div>
</div>
</div>
</div>
<div class="footer lightweight-theme">
<p>you're free to use the content on this blog for whatever you want</p>
<p>Created with <i class="em em-coffee"></i> <a href="https://github.com/huytd/ristretto-rs">ristretto.rs</a></p>
</div>
<script src="../js/highlight.pack.js"></script>
<script>
        </script>
<script type="text/javascript" async src="../../cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJaxb198.js?config=TeX-MML-AM_CHTML"></script>
<script type="text/x-mathjax-config">
         MathJax.Hub.Config({
             tex2jax: {
                 inlineMath: [['$','$'], ['\\(','\\)']],
                 skipTags: ["script","noscript","style","textarea", "code"],
                 ignoreClass: "tex2jax_ignore|comment|comment-list|content"
             }
         });
        </script>
<script src="../js/toc.js"></script>
<script src="../../www.gstatic.com/firebasejs/3.8.0/firebase.js"></script>
<script>
         let postCommentURL = '../api/post/rust-borrow-checker-part-1.json';
         // Initialize Firebase
         var config = {
             apiKey: "AIzaSyA1PnIAlJJ-U6iQJMNnCOknBuziBqGMYcY",
             authDomain: "huys-blog-comment.firebaseapp.com",
             databaseURL: "https://huys-blog-comment.firebaseio.com",
             projectId: "huys-blog-comment",
             storageBucket: "huys-blog-comment.appspot.com",
             messagingSenderId: "317330376829"
         };

         var login = function() {
             window.auth.signInWithPopup(provider)
                   .then(function(result) {
                   }).catch(function(err) {
                   });
         };

         var goninja = function() {
             updateAuth({
                 displayName: "Không Tên",
                 photoURL: "https://thefullsnack.com/img/kaonashi.jpg"
             });
         };

         var updateAuth = function(user) {
             if (user) {
                 currentUser = user;
                 // Logged in
                 document.getElementById("login-box").style.display = "none";
                 document.getElementById("comment-box").style.display = "flex";
                 document.getElementById("user-avatar").setAttribute("src", user.photoURL + "?sz=32");
             } else {
                 // Not login yet
                 document.getElementById("comment-box").style.display = "none";
                 document.getElementById("login-box").style.display = "block";
             }
         };

         var encodeHTML = function(s) {
             return s.replace(/</g, '&lt;').replace(/"/g, '&quot;').replace(/>/g, '&gt;');
         };

         var saveNewComment = function(comment) {
             if (!currentUser) {
                 return;
             }
             var commentData = {
                 username: currentUser.displayName,
                 avatar: currentUser.photoURL,
                 post_time: ~~((new Date()).getTime() / 1000),
                 message: encodeHTML(comment)
             };

             fetch(postCommentURL, {
                 method: 'post',
                 headers: {
                     "Content-Type": "application/json"
                 },
                 body: JSON.stringify(commentData)
             }).then((result) => {
                 if (result.status === 200) {
                     addNewComment(commentData.username, commentData.avatar, commentData.post_time, commentData.message);
                 }
             });

             document.getElementById("comment-content").value = "";
         };

         function debounce(func, wait, immediate) {
             var timeout;
             return function() {
                 var context = this, args = arguments;
                 var later = function() {
                     timeout = null;
                     if (!immediate) func.apply(context, args);
                 };
                 var callNow = immediate && !timeout;
                 clearTimeout(timeout);
                 timeout = setTimeout(later, wait);
                 if (callNow) func.apply(context, args);
             };
         };

         var submitData = debounce(function() {
             var comment = document.getElementById("comment-content").value;
             if (comment.length) {
                 saveNewComment(comment);
             }
         }, 250);

         var submitComment = function(e) {
             var keyCode = e.which || e.keyCode;
             var ctrlCode = e.ctrlKey || e.metaKey;
             if (keyCode === 13 && ctrlCode) {
                 submitData();
             }
         };

         var filterNewlineInComment = function(t) {
             return t.replace(/\n/g, "<br/>");
         };

         var filterURLinComment = function(comment) {
             return comment.replace(/(https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9]\.[^\s]{2,})/g, "<a target='_blank' rel='noopener noreferrer' href='$1'>$1</a>");
         };

         var addNewComment = function(user, avatar, time, comment, first) {
             var commentFiltered = encodeHTML(comment);
             commentFiltered = filterNewlineInComment(filterURLinComment(commentFiltered));
             commentFiltered = commentFiltered.replace(/```/g, '');
             var d = new Date(time * 1000);
             var commentTime = d.toLocaleTimeString() + ' ' + d.toLocaleDateString();
             var anoNameClass = (avatar.indexOf('thefullsnack.com') !== -1) ? "grey" : "";
             var html = '<div class="avatar">' +
                        '   <img src="' + avatar + '?sz=32" width="32" height="32"/>' +
                        ' </div>' +
                        '<div class="comment">' +
                        '  <div class="metadata"><b class="' + anoNameClass + '">' + encodeHTML(user) + '</b> lúc <span>' + commentTime + '</span></div>' +
                        '  <div class="content tex2jax_ignore">' + commentFiltered
             '  </div>' +
                        '</div>';
             var li = document.createElement('li');
             li.innerHTML = html;
             if (!first) {
                 document.getElementById("comment-list").append(li);
             } else {
                 let elm = document.getElementById("comment-list");
                 elm.insertBefore(li, elm.firstChild);
             }
         };



         window.onload = function() {

             document.querySelectorAll("pre code").forEach(el => {
                 hljs.highlightBlock(el);
             });

             start_toc_module();

             firebase.initializeApp(config);
             window.provider = new firebase.auth.GoogleAuthProvider();
             window.auth = firebase.auth();
             window.currentUser = null;

             window.auth.onAuthStateChanged(function(user) {
                 updateAuth(user);
             });


             // Fetch comment and put to posts
             fetch(postCommentURL)
                 .then(res => res.json())
                 .then(data => {
                     if (data.comments) {
                         let comments = data.comments;
                         comments.sort((a, b) => a.post_time - b.post_time);
                         for (let i = 0; i < comments.length; i++) {
                             let cmt = comments[i];
                             addNewComment(cmt.username, cmt.avatar, cmt.post_time, cmt.message);
                         }
                     }
                 });
         };

         var toggle_wordwise = function(status) {
             var book = document.querySelector("book");
             var on = document.querySelector("#ww_on");
             var off = document.querySelector("#ww_off");
             if (!status) {
                 book.className = "off";
                 on.className = "btn-toggle";
                 off.className = "btn-toggle active";
             } else {
                 book.className = "";
                 on.className = "btn-toggle active";
                 off.className = "btn-toggle";
             }
         };
        </script>
</body>

<!-- Mirrored from thefullsnack.com/posts/rust-borrow-checker-part-1.html by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 12 May 2020 03:19:43 GMT -->
</html>
